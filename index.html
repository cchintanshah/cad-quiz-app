<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="SN Quiz App - A modern quiz application for ServiceNow certification preparation">
    <meta name="theme-color" content="#7c3aed">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SN Quiz">
    <link rel="manifest" href="manifest.json">
    <title>SN Quiz App</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-bg-alt {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-ring {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .correct-glow {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .incorrect-glow {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        .option-selected-single {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.4) 0%, rgba(124, 58, 237, 0.3) 100%) !important;
            border-color: rgb(167, 139, 250) !important;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }

        .option-selected-multi {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.4) 0%, rgba(249, 115, 22, 0.3) 100%) !important;
            border-color: rgb(251, 146, 60) !important;
            box-shadow: 0 0 20px rgba(251, 146, 60, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
        }

        .hide {
            display: none !important;
        }

        .sync-indicator {
            animation: syncPulse 1.5s ease-in-out infinite;
        }

        @keyframes syncPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="fixed inset-0 flex items-center justify-center z-50 bg-slate-900">
        <div class="text-center">
            <div
                class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4">
            </div>
            <p class="text-xl text-purple-300">Loading SN Quiz App...</p>
            <p class="text-sm text-gray-500 mt-2" id="loadingStatus">Connecting to cloud...</p>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app" class="hide">
        <!-- Navigation -->
        <nav id="navbar" class="fixed top-0 left-0 right-0 z-40 glass">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3 cursor-pointer" onclick="goToDashboard()">
                    <div class="w-10 h-10 gradient-bg rounded-xl flex items-center justify-center">
                        <i class="fas fa-brain text-xl"></i>
                    </div>
                    <span class="font-bold text-xl hidden sm:block">SN Quiz App</span>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Cloud Sync Status -->
                    <div id="syncStatus" class="flex items-center gap-2 text-sm">
                        <i class="fas fa-cloud text-green-400" id="syncIcon"></i>
                        <span id="syncText" class="text-green-300 hidden sm:inline">Synced</span>
                    </div>
                    <div id="userInfo" class="hidden sm:flex items-center gap-2 text-sm">
                        <i class="fas fa-user-circle text-purple-400"></i>
                        <span id="userLicenseDisplay" class="text-purple-300"></span>
                    </div>
                    <button id="logoutBtn" onclick="logout()"
                        class="hide px-4 py-2 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </div>
        </nav>

        <!-- Login Screen -->
        <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 pt-20">
            <div class="w-full max-w-md slide-in">
                <div class="text-center mb-8">
                    <div
                        class="w-24 h-24 gradient-bg rounded-3xl flex items-center justify-center mx-auto mb-6 pulse-animation">
                        <i class="fas fa-graduation-cap text-5xl"></i>
                    </div>
                    <h1 class="text-4xl font-bold mb-2">SN Quiz App</h1>
                    <p class="text-purple-300">Master your knowledge with confidence</p>
                    <div class="mt-3 flex items-center justify-center gap-2 text-sm text-green-400">
                        <i class="fas fa-cloud"></i>
                        <span>Cloud-synced progress across all devices</span>
                    </div>
                </div>

                <div class="glass rounded-2xl p-8">
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2 text-purple-300">License Key</label>
                        <div class="relative">
                            <input type="password" id="licenseKeyInput"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 transition"
                                placeholder="Enter your license key">
                            <button onclick="togglePasswordVisibility()"
                                class="absolute right-3 top-1/2 -translate-y-1/2 text-purple-400 hover:text-purple-300">
                                <i id="passwordToggleIcon" class="fas fa-eye"></i>
                            </button>
                        </div>
                        <p id="loginError" class="text-red-400 text-sm mt-2 hide"></p>
                    </div>

                    <button onclick="validateLicense()" id="loginBtn"
                        class="w-full py-3 gradient-bg rounded-xl font-semibold hover:opacity-90 transition flex items-center justify-center gap-2">
                        <i class="fas fa-unlock"></i>
                        Access Quiz
                    </button>

                    <div class="mt-6 pt-6 border-t border-white/10 text-center">
                        <p class="text-sm text-purple-300 mb-3">Are you an administrator?</p>
                        <button onclick="showAdminLogin()"
                            class="text-purple-400 hover:text-purple-300 text-sm underline">
                            <i class="fas fa-cog mr-1"></i>Admin Panel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Login Modal -->
        <div id="adminLoginModal" class="hide fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-8 w-full max-w-md slide-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold"><i class="fas fa-shield-alt text-purple-400 mr-2"></i>Admin Login
                    </h2>
                    <button onclick="closeAdminLogin()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2 text-purple-300">Admin Password</label>
                    <input type="password" id="adminPasswordInput"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:border-purple-500 transition"
                        placeholder="Enter admin password">
                    <p id="adminLoginError" class="text-red-400 text-sm mt-2 hide"></p>
                </div>
                <button onclick="validateAdmin()"
                    class="w-full py-3 gradient-bg-alt rounded-xl font-semibold hover:opacity-90 transition">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login as Admin
                </button>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hide min-h-screen p-4 pt-24 pb-16">
            <div class="max-w-4xl mx-auto slide-in">
                <div class="flex items-center justify-between mb-8">
                    <h1 class="text-3xl font-bold"><i class="fas fa-cog text-purple-400 mr-3"></i>Admin Panel</h1>
                    <button onclick="exitAdminPanel()"
                        class="px-4 py-2 bg-white/10 rounded-lg hover:bg-white/20 transition">
                        <i class="fas fa-arrow-left mr-2"></i>Back
                    </button>
                </div>

                <!-- License Key Management -->
                <div class="glass rounded-2xl p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4"><i class="fas fa-key text-yellow-400 mr-2"></i>License Key
                        Management</h2>

                    <div class="grid md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-purple-300">New License Key</label>
                            <input type="text" id="newLicenseKey"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:border-purple-500 transition"
                                placeholder="Enter new license key">
                        </div>
                        <div class="flex items-end">
                            <button onclick="addLicenseKey()"
                                class="w-full py-3 bg-green-500 rounded-xl font-semibold hover:bg-green-600 transition">
                                <i class="fas fa-plus mr-2"></i>Add License Key
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <button onclick="generateRandomKey()"
                            class="px-4 py-2 bg-purple-500/30 text-purple-300 rounded-lg hover:bg-purple-500/40 transition mr-2">
                            <i class="fas fa-random mr-2"></i>Generate Random Key
                        </button>
                        <button onclick="exportLicenseKeys()"
                            class="px-4 py-2 bg-blue-500/30 text-blue-300 rounded-lg hover:bg-blue-500/40 transition">
                            <i class="fas fa-download mr-2"></i>Export Keys
                        </button>
                    </div>

                    <div id="licenseKeysList" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- License keys will be populated here -->
                    </div>
                </div>

                <!-- Statistics -->
                <div class="glass rounded-2xl p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4"><i class="fas fa-chart-bar text-blue-400 mr-2"></i>Statistics
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white/5 rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-purple-400" id="totalKeysCount">0</p>
                            <p class="text-sm text-gray-400">Total Keys</p>
                        </div>
                        <div class="bg-white/5 rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-green-400" id="activeKeysCount">0</p>
                            <p class="text-sm text-gray-400">Active Keys</p>
                        </div>
                        <div class="bg-white/5 rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-blue-400" id="totalQuestionsCount">385</p>
                            <p class="text-sm text-gray-400">Questions</p>
                        </div>
                        <div class="bg-white/5 rounded-xl p-4 text-center">
                            <p class="text-3xl font-bold text-yellow-400">8</p>
                            <p class="text-sm text-gray-400">Sections</p>
                        </div>
                    </div>
                </div>

                <!-- Change Admin Password -->
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4"><i class="fas fa-lock text-red-400 mr-2"></i>Change Admin
                        Password</h2>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2 text-purple-300">Current Password</label>
                            <input type="password" id="currentAdminPass"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:border-purple-500 transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 text-purple-300">New Password</label>
                            <input type="password" id="newAdminPass"
                                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl focus:outline-none focus:border-purple-500 transition">
                        </div>
                        <div class="flex items-end">
                            <button onclick="changeAdminPassword()"
                                class="w-full py-3 bg-red-500 rounded-xl font-semibold hover:bg-red-600 transition">
                                <i class="fas fa-key mr-2"></i>Change Password
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hide min-h-screen p-4 pt-24 pb-20">
            <div class="max-w-6xl mx-auto slide-in">
                <!-- Welcome Header -->
                <div class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold mb-2">Welcome to SN Quiz App</h1>
                    <p class="text-purple-300">Select a section to start your quiz journey</p>
                    <div class="mt-2 flex items-center justify-center gap-2 text-sm text-green-400">
                        <i class="fas fa-check-circle"></i>
                        <span>Your progress is automatically saved to cloud</span>
                    </div>
                </div>

                <!-- Section Cards -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8" id="sectionCards">
                    <!-- Section cards will be populated here -->
                </div>

                <!-- Final Exam Card -->
                <div class="glass rounded-2xl p-6 card-hover cursor-pointer" onclick="startQuiz('final')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 gradient-bg-alt rounded-2xl flex items-center justify-center">
                                <i class="fas fa-trophy text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold">Final Exam</h3>
                                <p class="text-purple-300 text-sm">60 Random Questions • 90 Minutes</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold" id="finalExamScore">0%</p>
                            <p class="text-xs text-gray-400">Best Score</p>
                        </div>
                    </div>
                </div>

                <!-- Resume Quiz Banner -->
                <div id="resumeBanner" class="hide glass rounded-2xl p-6 mt-8 border-2 border-purple-500/50">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 bg-purple-500/30 rounded-xl flex items-center justify-center">
                                <i class="fas fa-play-circle text-2xl text-purple-400"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg">Resume Your Quiz</h3>
                                <p class="text-sm text-purple-300" id="resumeInfo">Section 1 • Question 5 of 60</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="resumeQuiz()"
                                class="px-6 py-3 gradient-bg rounded-xl font-semibold hover:opacity-90 transition">
                                <i class="fas fa-play mr-2"></i>Resume
                            </button>
                            <button onclick="clearSavedQuiz()"
                                class="px-4 py-3 bg-red-500/20 text-red-400 rounded-xl hover:bg-red-500/30 transition">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grid md:grid-cols-3 gap-4 mt-8">
                    <button onclick="startStudyMode()"
                        class="glass rounded-xl p-4 flex items-center gap-4 hover:bg-white/10 transition card-hover">
                        <div class="w-12 h-12 bg-blue-500/30 rounded-xl flex items-center justify-center">
                            <i class="fas fa-book-open text-xl text-blue-400"></i>
                        </div>
                        <div class="text-left">
                            <h4 class="font-semibold">Study Mode</h4>
                            <p class="text-xs text-gray-400">Learn without timer</p>
                        </div>
                    </button>
                    <button onclick="viewBookmarks()"
                        class="glass rounded-xl p-4 flex items-center gap-4 hover:bg-white/10 transition card-hover">
                        <div class="w-12 h-12 bg-yellow-500/30 rounded-xl flex items-center justify-center">
                            <i class="fas fa-bookmark text-xl text-yellow-400"></i>
                        </div>
                        <div class="text-left">
                            <h4 class="font-semibold">Bookmarks</h4>
                            <p class="text-xs text-gray-400" id="bookmarkCount">0 saved questions</p>
                        </div>
                    </button>
                    <button onclick="viewWrongAnswers()"
                        class="glass rounded-xl p-4 flex items-center gap-4 hover:bg-white/10 transition card-hover">
                        <div class="w-12 h-12 bg-red-500/30 rounded-xl flex items-center justify-center">
                            <i class="fas fa-times-circle text-xl text-red-400"></i>
                        </div>
                        <div class="text-left">
                            <h4 class="font-semibold">Review Wrong</h4>
                            <p class="text-xs text-gray-400" id="wrongCount">0 to review</p>
                        </div>
                    </button>
                </div>

                <!-- Reset Progress -->
                <div class="mt-8 text-center">
                    <button onclick="showResetModal()" class="text-gray-500 hover:text-gray-300 text-sm transition">
                        <i class="fas fa-redo mr-1"></i>Reset All Progress
                    </button>
                </div>
            </div>
        </div>

        <!-- Reset Progress Modal -->
        <div id="resetModal" class="hide fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-8 w-full max-w-md slide-in">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-red-500/30 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-400"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Reset All Progress?</h2>
                    <p class="text-gray-400">This will delete all your scores, bookmarks, and progress from cloud. This
                        action cannot be undone.</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="closeResetModal()"
                        class="flex-1 py-3 glass rounded-xl font-semibold hover:bg-white/10 transition">
                        Cancel
                    </button>
                    <button onclick="resetAllProgress()"
                        class="flex-1 py-3 bg-red-500 rounded-xl font-semibold hover:bg-red-600 transition">
                        <i class="fas fa-trash mr-2"></i>Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="hide min-h-screen p-4 pt-24 pb-20">
            <div class="max-w-3xl mx-auto">
                <!-- Quiz Header -->
                <div class="glass rounded-2xl p-4 mb-6 slide-in">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <button onclick="exitQuiz()" class="p-2 hover:bg-white/10 rounded-lg transition">
                                <i class="fas fa-arrow-left text-xl"></i>
                            </button>
                            <div>
                                <h2 class="font-bold" id="quizTitle">Section 1</h2>
                                <p class="text-sm text-purple-300" id="quizSubtitle">Question 1 of 60</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-6">
                            <!-- Timer -->
                            <div class="flex items-center gap-2" id="timerContainer">
                                <svg class="w-12 h-12" viewBox="0 0 36 36">
                                    <circle cx="18" cy="18" r="16" fill="none" stroke="rgba(255,255,255,0.1)"
                                        stroke-width="3" />
                                    <circle id="timerCircle" class="progress-ring" cx="18" cy="18" r="16" fill="none"
                                        stroke="#a855f7" stroke-width="3" stroke-linecap="round"
                                        stroke-dasharray="100.53" stroke-dashoffset="0" />
                                </svg>
                                <span id="timerDisplay" class="text-xl font-bold">90</span>
                            </div>
                            <!-- Score -->
                            <div class="text-center">
                                <p class="text-xl font-bold text-green-400" id="currentScore">0</p>
                                <p class="text-xs text-gray-400">Score</p>
                            </div>
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div class="mt-4 bg-white/10 rounded-full h-2 overflow-hidden">
                        <div id="quizProgressBar" class="h-full gradient-bg transition-all duration-300"
                            style="width: 0%"></div>
                    </div>
                </div>

                <!-- Question Card -->
                <div id="questionCard" class="glass rounded-2xl p-6 mb-6 slide-in">
                    <div class="flex items-start justify-between mb-4">
                        <span class="px-3 py-1 bg-purple-500/30 text-purple-300 rounded-full text-sm"
                            id="questionType">Single Choice</span>
                        <button onclick="toggleBookmark()" id="bookmarkBtn"
                            class="p-2 hover:bg-white/10 rounded-lg transition">
                            <i class="far fa-bookmark text-xl" id="bookmarkIcon"></i>
                        </button>
                    </div>
                    <h3 class="text-xl font-semibold mb-6" id="questionText">Loading question...</h3>

                    <div id="optionsContainer" class="space-y-3">
                        <!-- Options will be populated here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-between items-center slide-in">
                    <button id="prevBtn" onclick="previousQuestion()"
                        class="px-6 py-3 glass rounded-xl hover:bg-white/10 transition hide">
                        <i class="fas fa-chevron-left mr-2"></i>Previous
                    </button>
                    <button id="submitBtn" onclick="submitAnswer()"
                        class="px-8 py-3 gradient-bg rounded-xl font-semibold hover:opacity-90 transition">
                        Submit Answer
                    </button>
                    <button id="nextBtn" onclick="nextQuestion()"
                        class="px-6 py-3 glass rounded-xl hover:bg-white/10 transition hide">
                        Next<i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>

                <!-- Answer Feedback -->
                <div id="feedbackContainer" class="hide mt-6 glass rounded-2xl p-6 slide-in">
                    <div id="feedbackContent"></div>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hide min-h-screen p-4 pt-24 pb-20">
            <div class="max-w-2xl mx-auto text-center slide-in">
                <div id="resultsIcon" class="w-32 h-32 mx-auto mb-6 rounded-full flex items-center justify-center">
                    <i class="fas fa-trophy text-6xl"></i>
                </div>
                <h1 class="text-4xl font-bold mb-2" id="resultsTitle">Quiz Complete!</h1>
                <p class="text-purple-300 mb-8" id="resultsSubtitle">Great job on completing the quiz</p>

                <div class="glass rounded-2xl p-8 mb-8">
                    <div class="grid grid-cols-3 gap-6 mb-8">
                        <div>
                            <p class="text-4xl font-bold text-green-400" id="resultsCorrect">0</p>
                            <p class="text-sm text-gray-400">Correct</p>
                        </div>
                        <div>
                            <p class="text-4xl font-bold text-red-400" id="resultsIncorrect">0</p>
                            <p class="text-sm text-gray-400">Incorrect</p>
                        </div>
                        <div>
                            <p class="text-4xl font-bold text-purple-400" id="resultsPercentage">0%</p>
                            <p class="text-sm text-gray-400">Score</p>
                        </div>
                    </div>

                    <div class="bg-white/10 rounded-full h-4 overflow-hidden mb-4">
                        <div id="resultsProgressBar" class="h-full gradient-bg transition-all duration-1000"
                            style="width: 0%"></div>
                    </div>

                    <p class="text-sm text-gray-400" id="resultsMessage">You passed! Keep up the great work!</p>

                    <div class="mt-4 flex items-center justify-center gap-2 text-sm text-green-400">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Progress saved to cloud</span>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button onclick="retryQuiz()"
                        class="px-8 py-3 gradient-bg rounded-xl font-semibold hover:opacity-90 transition">
                        <i class="fas fa-redo mr-2"></i>Try Again
                    </button>
                    <button onclick="reviewAnswers()"
                        class="px-8 py-3 glass rounded-xl font-semibold hover:bg-white/10 transition">
                        <i class="fas fa-eye mr-2"></i>Review Answers
                    </button>
                    <button onclick="goToDashboard()"
                        class="px-8 py-3 glass rounded-xl font-semibold hover:bg-white/10 transition">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </button>
                </div>
            </div>
        </div>

        <!-- Study Mode Selection Modal -->
        <div id="studyModeModal" class="hide fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="glass rounded-2xl p-8 w-full max-w-md slide-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold"><i class="fas fa-book text-blue-400 mr-2"></i>Study Mode</h2>
                    <button onclick="closeStudyMode()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <p class="text-purple-300 mb-6">Select a section to study without timer pressure:</p>
                <div id="studyModeSections" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Sections will be populated here -->
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast"
            class="fixed bottom-20 right-4 glass rounded-xl p-4 transform translate-x-full transition-transform duration-300 z-50">
            <div class="flex items-center gap-3">
                <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
                <span id="toastMessage">Success message</span>
            </div>
        </div>

        <!-- Footer -->
        <footer id="appFooter" class="fixed bottom-0 left-0 right-0 glass py-3 px-4 text-center z-30">
            <div class="flex items-center justify-center gap-2 text-sm text-purple-300">
                <i class="fas fa-code text-purple-400"></i>
                <span>Developed with</span>
                <i class="fas fa-heart text-red-400 pulse-animation"></i>
                <span>by</span>
                <a href="#" class="font-semibold text-purple-400 hover:text-purple-300 transition">Chintan Shah</a>
            </div>
        </footer>
    </div>

    <script>
        // ==================== SUPABASE CONFIGURATION ====================
        // IMPORTANT: Replace these with your Supabase project credentials
        const SUPABASE_URL = 'https://idromcktecrfctliraru.supabase.co'; // e.g., 'https://xxxxx.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlkcm9tY2t0ZWNyZmN0bGlyYXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NjI2MzcsImV4cCI6MjA4NTAzODYzN30.mcMisFnbrGwaEqI8Ze0e83vR0ugizIfj6p4ooQdxviI'; // Your anon/public key

        // Initialize Supabase client
        let supabase = null;
        let isOnline = navigator.onLine;

        // ==================== CONFIGURATION ====================
        const CONFIG = {
            questionTimeLimit: 90, // seconds
            finalExamTimeLimit: 90 * 60, // 90 minutes in seconds
            sectionsConfig: [
                { id: 1, name: 'Section 1', start: 1, end: 60, icon: 'fa-database' },
                { id: 2, name: 'Section 2', start: 61, end: 120, icon: 'fa-cogs' },
                { id: 3, name: 'Section 3', start: 121, end: 180, icon: 'fa-code' },
                { id: 4, name: 'Section 4', start: 181, end: 204, icon: 'fa-server' }
            ],
            finalExamQuestions: 60
        };

        // ==================== STATE MANAGEMENT ====================
        let state = {
            currentUser: null,
            isAdmin: false,
            questions: [],
            currentSection: null,
            currentQuestionIndex: 0,
            currentQuizQuestions: [],
            selectedAnswers: [],
            score: 0,
            timer: null,
            timeRemaining: 0,
            isStudyMode: false,
            hasAnswered: false,
            sectionProgress: {},
            bookmarks: [],
            wrongAnswers: [],
            savedQuiz: null,
            answeredQuestions: [],
            isSyncing: false
        };

        // ==================== SUPABASE INITIALIZATION ====================
        async function initSupabase() {
            try {
                updateLoadingStatus('Initializing cloud connection...');

                if (SUPABASE_URL === 'https://idromcktecrfctliraru.supabase.co' || SUPABASE_ANON_KEY === 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlkcm9tY2t0ZWNyZmN0bGlyYXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk0NjI2MzcsImV4cCI6MjA4NTAzODYzN30.mcMisFnbrGwaEqI8Ze0e83vR0ugizIfj6p4ooQdxviI') {
                    console.warn('Supabase not configured. Running in offline mode.');
                    return false;
                }

                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // Test connection
                const { data, error } = await supabase.from('license_keys').select('count').limit(1);

                if (error) {
                    console.error('Supabase connection error:', error);
                    return false;
                }

                console.log('Supabase connected successfully');
                return true;
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                return false;
            }
        }

        // ==================== CLOUD SYNC FUNCTIONS ====================
        function updateSyncStatus(status, message = '') {
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncText');

            switch (status) {
                case 'syncing':
                    icon.className = 'fas fa-sync-alt text-yellow-400 sync-indicator';
                    text.textContent = 'Syncing...';
                    text.className = 'text-yellow-300 hidden sm:inline';
                    break;
                case 'synced':
                    icon.className = 'fas fa-cloud text-green-400';
                    text.textContent = 'Synced';
                    text.className = 'text-green-300 hidden sm:inline';
                    break;
                case 'offline':
                    icon.className = 'fas fa-cloud-slash text-gray-400';
                    text.textContent = 'Offline';
                    text.className = 'text-gray-400 hidden sm:inline';
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-circle text-red-400';
                    text.textContent = 'Sync Error';
                    text.className = 'text-red-300 hidden sm:inline';
                    break;
            }
        }

        async function syncToCloud() {
            if (!supabase || !state.currentUser || state.isSyncing) return;

            state.isSyncing = true;
            updateSyncStatus('syncing');

            try {
                // Sync section progress
                for (const [sectionId, progress] of Object.entries(state.sectionProgress)) {
                    await supabase.from('user_progress').upsert({
                        license_key: state.currentUser,
                        section_id: sectionId.toString(),
                        score: progress.correct || 0,
                        total_questions: progress.total || 0,
                        percentage: progress.percentage || 0,
                        last_attempt_at: new Date().toISOString()
                    }, { onConflict: 'license_key,section_id' });
                }

                // Sync bookmarks
                await supabase.from('bookmarks').delete().eq('license_key', state.currentUser);
                if (state.bookmarks.length > 0) {
                    const bookmarkInserts = state.bookmarks.map(qId => ({
                        license_key: state.currentUser,
                        question_id: qId
                    }));
                    await supabase.from('bookmarks').insert(bookmarkInserts);
                }

                // Sync wrong answers
                await supabase.from('wrong_answers').delete().eq('license_key', state.currentUser);
                if (state.wrongAnswers.length > 0) {
                    const wrongInserts = state.wrongAnswers.map(qId => ({
                        license_key: state.currentUser,
                        question_id: qId
                    }));
                    await supabase.from('wrong_answers').insert(wrongInserts);
                }

                updateSyncStatus('synced');
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('error');
            } finally {
                state.isSyncing = false;
            }
        }

        async function syncQuizSession() {
            if (!supabase || !state.currentUser || state.isStudyMode) return;

            try {
                const sessionData = {
                    license_key: state.currentUser,
                    section_id: state.currentSection.toString(),
                    current_question_index: state.currentQuestionIndex,
                    score: state.score,
                    question_ids: state.currentQuizQuestions.map(q => q.id),
                    answered_questions: state.answeredQuestions,
                    time_remaining: state.timeRemaining,
                    is_study_mode: state.isStudyMode,
                    updated_at: new Date().toISOString()
                };

                await supabase.from('quiz_sessions').upsert(sessionData, {
                    onConflict: 'license_key,section_id'
                });
            } catch (error) {
                console.error('Failed to sync quiz session:', error);
            }
        }

        async function loadFromCloud() {
            if (!supabase || !state.currentUser) return;

            updateSyncStatus('syncing');

            try {
                // Load progress
                const { data: progressData } = await supabase
                    .from('user_progress')
                    .select('*')
                    .eq('license_key', state.currentUser);

                if (progressData) {
                    state.sectionProgress = {};
                    progressData.forEach(p => {
                        state.sectionProgress[p.section_id] = {
                            correct: p.score,
                            total: p.total_questions,
                            percentage: p.percentage,
                            lastAttempt: p.last_attempt_at
                        };
                    });
                }

                // Load bookmarks
                const { data: bookmarksData } = await supabase
                    .from('bookmarks')
                    .select('question_id')
                    .eq('license_key', state.currentUser);

                if (bookmarksData) {
                    state.bookmarks = bookmarksData.map(b => b.question_id);
                }

                // Load wrong answers
                const { data: wrongData } = await supabase
                    .from('wrong_answers')
                    .select('question_id')
                    .eq('license_key', state.currentUser);

                if (wrongData) {
                    state.wrongAnswers = wrongData.map(w => w.question_id);
                }

                // Load active quiz session
                const { data: sessionData } = await supabase
                    .from('quiz_sessions')
                    .select('*')
                    .eq('license_key', state.currentUser)
                    .order('updated_at', { ascending: false })
                    .limit(1);

                if (sessionData && sessionData.length > 0) {
                    state.savedQuiz = {
                        section: sessionData[0].section_id,
                        questionIndex: sessionData[0].current_question_index,
                        score: sessionData[0].score,
                        questionsIds: sessionData[0].question_ids,
                        answeredQuestions: sessionData[0].answered_questions || [],
                        timeRemaining: sessionData[0].time_remaining
                    };
                }

                // Also save to local storage as backup
                saveToLocalStorage();

                updateSyncStatus('synced');
            } catch (error) {
                console.error('Failed to load from cloud:', error);
                updateSyncStatus('error');
                // Fall back to local storage
                loadFromLocalStorage();
            }
        }

        async function clearCloudSession(sectionId) {
            if (!supabase || !state.currentUser) return;

            try {
                await supabase
                    .from('quiz_sessions')
                    .delete()
                    .eq('license_key', state.currentUser)
                    .eq('section_id', sectionId.toString());
            } catch (error) {
                console.error('Failed to clear cloud session:', error);
            }
        }

        // ==================== LOCAL STORAGE (BACKUP) ====================
        function saveToLocalStorage() {
            localStorage.setItem('snquiz_progress', JSON.stringify(state.sectionProgress));
            localStorage.setItem('snquiz_bookmarks', JSON.stringify(state.bookmarks));
            localStorage.setItem('snquiz_wrong_answers', JSON.stringify(state.wrongAnswers));
            if (state.savedQuiz) {
                localStorage.setItem('snquiz_saved_quiz', JSON.stringify(state.savedQuiz));
            }
        }

        function loadFromLocalStorage() {
            const progress = localStorage.getItem('snquiz_progress');
            if (progress) state.sectionProgress = JSON.parse(progress);

            const bookmarks = localStorage.getItem('snquiz_bookmarks');
            if (bookmarks) state.bookmarks = JSON.parse(bookmarks);

            const wrong = localStorage.getItem('snquiz_wrong_answers');
            if (wrong) state.wrongAnswers = JSON.parse(wrong);

            const saved = localStorage.getItem('snquiz_saved_quiz');
            if (saved) state.savedQuiz = JSON.parse(saved);
        }

        // ==================== INITIALIZATION ====================
        async function init() {
            updateLoadingStatus('Loading questions...');
            await loadQuestions();

            updateLoadingStatus('Connecting to cloud...');
            const cloudConnected = await initSupabase();

            if (!cloudConnected) {
                updateSyncStatus('offline');
                loadFromLocalStorage();
            }

            // Check for saved session
            const savedUser = localStorage.getItem('snquiz_current_user');
            if (savedUser) {
                state.currentUser = savedUser;
                if (cloudConnected) {
                    updateLoadingStatus('Syncing your progress...');
                    await loadFromCloud();
                }
            }

            // Setup online/offline listeners
            window.addEventListener('online', () => {
                isOnline = true;
                if (state.currentUser) syncToCloud();
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                updateSyncStatus('offline');
            });

            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hide');
                document.getElementById('app').classList.remove('hide');

                if (state.currentUser) {
                    showDashboard();
                } else {
                    showLoginScreen();
                }
            }, 1000);
        }

        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        async function loadQuestions() {
            try {
                const response = await fetch('questions.json');
                if (response.ok) {
                    state.questions = await response.json();
                } else {
                    state.questions = generateSampleQuestions();
                }
            } catch (error) {
                console.log('Loading sample questions...');
                state.questions = generateSampleQuestions();
            }
            document.getElementById('totalQuestionsCount').textContent = state.questions.length;
        }

        function generateSampleQuestions() {
            const sampleQuestions = [];
            const topics = [
                'Service Catalog', 'CMDB', 'ITSM', 'Flow Designer', 'UI Policies',
                'Business Rules', 'Client Scripts', 'ACLs', 'Workflows', 'Reporting',
                'Service Portal', 'Knowledge Management', 'Incident Management',
                'Change Management', 'Problem Management', 'Asset Management'
            ];

            for (let i = 1; i <= 385; i++) {
                const topic = topics[i % topics.length];
                const isMulti = i % 5 === 0;

                let correct, questionText;
                if (isMulti) {
                    const shuffled = ['A', 'B', 'C', 'D'].sort(() => Math.random() - 0.5);
                    correct = shuffled.slice(0, 2).sort();
                    questionText = `Sample Question ${i}: Which of the following are valid ${topic} features in ServiceNow? (Choose two.)`;
                } else {
                    correct = [['A', 'B', 'C', 'D'][i % 4]];
                    questionText = `Sample Question ${i}: Which of the following best describes the ${topic} functionality in ServiceNow?`;
                }

                sampleQuestions.push({
                    id: i,
                    question: questionText,
                    options: {
                        A: `${topic} Option A - This is the first possible answer`,
                        B: `${topic} Option B - This is the second possible answer`,
                        C: `${topic} Option C - This is the third possible answer`,
                        D: `${topic} Option D - This is the fourth possible answer`
                    },
                    correct: correct,
                    type: isMulti ? 'multi' : 'single'
                });
            }
            return sampleQuestions;
        }

        // ==================== AUTHENTICATION ====================
        async function validateLicense() {
            const input = document.getElementById('licenseKeyInput');
            const error = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');
            const licenseKey = input.value.trim();

            if (!licenseKey) {
                showError(error, 'Please enter a license key');
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 500);
                return;
            }

            // Show loading state
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Validating...';

            let isValid = false;

            if (supabase) {
                // Validate against cloud database
                try {
                    const { data, error: queryError } = await supabase
                        .from('license_keys')
                        .select('*')
                        .eq('license_key', licenseKey)
                        .eq('is_active', true)
                        .single();

                    if (data && !queryError) {
                        // Check expiry
                        if (data.expires_at && new Date(data.expires_at) < new Date()) {
                            showError(error, 'This license key has expired.');
                            isValid = false;
                        } else {
                            isValid = true;
                        }
                    }
                } catch (e) {
                    console.error('License validation error:', e);
                }
            }

            // Fallback to local validation
            if (!isValid && !supabase) {
                const localKeys = ['SNQUIZ-2024-DEMO', 'SNQUIZ-FREE-TRIAL'];
                isValid = localKeys.includes(licenseKey);
            }

            loginBtn.disabled = false;
            loginBtn.innerHTML = '<i class="fas fa-unlock"></i> Access Quiz';

            if (isValid) {
                state.currentUser = licenseKey;
                localStorage.setItem('snquiz_current_user', licenseKey);

                // Load user's data from cloud
                if (supabase) {
                    await loadFromCloud();
                }

                showToast('Welcome! Your progress syncs across all devices.', 'success');
                showDashboard();
            } else {
                showError(error, 'Invalid license key. Please try again.');
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 500);
            }
        }

        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('hide');
        }

        function closeAdminLogin() {
            document.getElementById('adminLoginModal').classList.add('hide');
            document.getElementById('adminPasswordInput').value = '';
            document.getElementById('adminLoginError').classList.add('hide');
        }

        async function validateAdmin() {
            const input = document.getElementById('adminPasswordInput');
            const error = document.getElementById('adminLoginError');
            const password = input.value.trim();

            let isValid = false;

            if (supabase) {
                try {
                    const { data } = await supabase
                        .from('admin_settings')
                        .select('setting_value')
                        .eq('setting_key', 'admin_password')
                        .single();

                    if (data && data.setting_value === password) {
                        isValid = true;
                    }
                } catch (e) {
                    console.error('Admin validation error:', e);
                }
            }

            // Fallback
            if (!isValid && password === 'admin123') {
                isValid = true;
            }

            if (isValid) {
                state.isAdmin = true;
                closeAdminLogin();
                showAdminPanel();
                showToast('Welcome, Administrator!', 'success');
            } else {
                showError(error, 'Invalid admin password');
                input.classList.add('shake');
                setTimeout(() => input.classList.remove('shake'), 500);
            }
        }

        function logout() {
            state.currentUser = null;
            state.isAdmin = false;
            state.sectionProgress = {};
            state.bookmarks = [];
            state.wrongAnswers = [];
            state.savedQuiz = null;
            localStorage.removeItem('snquiz_current_user');
            showLoginScreen();
            showToast('Logged out successfully', 'info');
        }

        // ==================== SCREEN NAVIGATION ====================
        function hideAllScreens() {
            document.getElementById('loginScreen').classList.add('hide');
            document.getElementById('adminPanel').classList.add('hide');
            document.getElementById('dashboard').classList.add('hide');
            document.getElementById('quizScreen').classList.add('hide');
            document.getElementById('resultsScreen').classList.add('hide');
        }

        function showLoginScreen() {
            hideAllScreens();
            document.getElementById('loginScreen').classList.remove('hide');
            document.getElementById('logoutBtn').classList.add('hide');
            document.getElementById('userInfo').classList.add('hide');
            document.getElementById('licenseKeyInput').value = '';
        }

        function showAdminPanel() {
            hideAllScreens();
            document.getElementById('adminPanel').classList.remove('hide');
            document.getElementById('logoutBtn').classList.remove('hide');
            updateAdminPanel();
        }

        function exitAdminPanel() {
            state.isAdmin = false;
            showLoginScreen();
        }

        function showDashboard() {
            hideAllScreens();
            document.getElementById('dashboard').classList.remove('hide');
            document.getElementById('logoutBtn').classList.remove('hide');
            document.getElementById('userInfo').classList.remove('hide');
            document.getElementById('userLicenseDisplay').textContent = maskLicense(state.currentUser);
            updateDashboard();
        }

        function goToDashboard() {
            if (state.timer) {
                clearInterval(state.timer);
                state.timer = null;
            }
            if (state.currentUser) {
                showDashboard();
            }
        }

        // ==================== ADMIN PANEL ====================
        async function updateAdminPanel() {
            let keys = [];

            if (supabase) {
                try {
                    const { data } = await supabase.from('license_keys').select('*').order('created_at', { ascending: false });
                    if (data) keys = data;
                } catch (e) {
                    console.error('Failed to load keys:', e);
                }
            }

            const listContainer = document.getElementById('licenseKeysList');

            listContainer.innerHTML = keys.map((key) => `
                <div class="flex items-center justify-between bg-white/5 rounded-xl p-3">
                    <div class="flex items-center gap-3 flex-1">
                        <i class="fas fa-key ${key.is_active ? 'text-yellow-400' : 'text-gray-500'}"></i>
                        <div class="flex-1">
                            <code class="text-sm">${key.license_key}</code>
                            <div class="text-xs text-gray-500">
                                ${key.is_active ? '<span class="text-green-400">Active</span>' : '<span class="text-red-400">Inactive</span>'}
                                ${key.expires_at ? ` • Expires: ${new Date(key.expires_at).toLocaleDateString()}` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleKeyStatus('${key.id}', ${!key.is_active})" 
                            class="p-2 ${key.is_active ? 'text-yellow-400 hover:bg-yellow-500/20' : 'text-green-400 hover:bg-green-500/20'} rounded-lg transition">
                            <i class="fas ${key.is_active ? 'fa-pause' : 'fa-play'}"></i>
                        </button>
                        <button onclick="deleteLicenseKey('${key.id}')" class="p-2 text-red-400 hover:bg-red-500/20 rounded-lg transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            const activeCount = keys.filter(k => k.is_active).length;
            document.getElementById('totalKeysCount').textContent = keys.length;
            document.getElementById('activeKeysCount').textContent = activeCount;
        }

        async function addLicenseKey() {
            const input = document.getElementById('newLicenseKey');
            const key = input.value.trim();

            if (!key) {
                showToast('Please enter a license key', 'error');
                return;
            }

            if (supabase) {
                try {
                    const { error } = await supabase.from('license_keys').insert({
                        license_key: key,
                        is_active: true
                    });

                    if (error) {
                        if (error.code === '23505') {
                            showToast('This license key already exists', 'error');
                        } else {
                            showToast('Failed to add key: ' + error.message, 'error');
                        }
                        return;
                    }

                    input.value = '';
                    updateAdminPanel();
                    showToast('License key added successfully', 'success');
                } catch (e) {
                    showToast('Failed to add license key', 'error');
                }
            }
        }

        async function deleteLicenseKey(id) {
            if (!confirm('Are you sure you want to delete this license key?')) return;

            if (supabase) {
                try {
                    await supabase.from('license_keys').delete().eq('id', id);
                    updateAdminPanel();
                    showToast('License key deleted', 'success');
                } catch (e) {
                    showToast('Failed to delete key', 'error');
                }
            }
        }

        async function toggleKeyStatus(id, newStatus) {
            if (supabase) {
                try {
                    await supabase.from('license_keys').update({ is_active: newStatus }).eq('id', id);
                    updateAdminPanel();
                    showToast(`License key ${newStatus ? 'activated' : 'deactivated'}`, 'success');
                } catch (e) {
                    showToast('Failed to update key', 'error');
                }
            }
        }

        function generateRandomKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = 'SNQUIZ-';
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    key += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                if (i < 3) key += '-';
            }
            document.getElementById('newLicenseKey').value = key;
        }

        async function exportLicenseKeys() {
            if (supabase) {
                try {
                    const { data } = await supabase.from('license_keys').select('license_key, is_active, created_at, expires_at');
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'license_keys.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('License keys exported', 'success');
                } catch (e) {
                    showToast('Failed to export keys', 'error');
                }
            }
        }

        async function changeAdminPassword() {
            const current = document.getElementById('currentAdminPass').value;
            const newPass = document.getElementById('newAdminPass').value;

            if (newPass.length < 6) {
                showToast('New password must be at least 6 characters', 'error');
                return;
            }

            if (supabase) {
                try {
                    const { data } = await supabase
                        .from('admin_settings')
                        .select('setting_value')
                        .eq('setting_key', 'admin_password')
                        .single();

                    if (data && data.setting_value === current) {
                        await supabase
                            .from('admin_settings')
                            .update({ setting_value: newPass, updated_at: new Date().toISOString() })
                            .eq('setting_key', 'admin_password');

                        document.getElementById('currentAdminPass').value = '';
                        document.getElementById('newAdminPass').value = '';
                        showToast('Admin password changed successfully', 'success');
                    } else {
                        showToast('Current password is incorrect', 'error');
                    }
                } catch (e) {
                    showToast('Failed to change password', 'error');
                }
            }
        }

        // ==================== DASHBOARD ====================
        function updateDashboard() {
            const container = document.getElementById('sectionCards');

            container.innerHTML = CONFIG.sectionsConfig.map(section => {
                const progress = state.sectionProgress[section.id] || { correct: 0, total: 0, percentage: 0 };
                const totalQuestions = section.end - section.start + 1;

                return `
                    <div class="glass rounded-2xl p-5 card-hover cursor-pointer" onclick="startQuiz(${section.id})">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center">
                                <i class="fas ${section.icon} text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold">${section.name}</h3>
                                <p class="text-sm text-purple-300">Q${section.start}-${section.end}</p>
                            </div>
                        </div>
                        <div class="mb-2">
                            <div class="flex justify-between text-sm mb-1">
                                <span>${progress.correct}/${totalQuestions} completed</span>
                                <span class="text-purple-400">${progress.percentage}%</span>
                            </div>
                            <div class="bg-white/10 rounded-full h-2 overflow-hidden">
                                <div class="h-full gradient-bg transition-all duration-500" style="width: ${progress.percentage}%"></div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-400">
                            <span><i class="fas fa-clock mr-1"></i>90s/question</span>
                            <span><i class="fas fa-star mr-1"></i>${progress.correct} pts</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Update final exam score
            const finalProgress = state.sectionProgress['final'] || { percentage: 0 };
            document.getElementById('finalExamScore').textContent = finalProgress.percentage + '%';

            // Update bookmark and wrong counts
            document.getElementById('bookmarkCount').textContent = state.bookmarks.length + ' saved questions';
            document.getElementById('wrongCount').textContent = state.wrongAnswers.length + ' to review';

            // Show resume banner
            const resumeBanner = document.getElementById('resumeBanner');
            if (state.savedQuiz) {
                resumeBanner.classList.remove('hide');
                let sectionName = 'Final Exam';
                if (state.savedQuiz.section !== 'final') {
                    const section = CONFIG.sectionsConfig.find(s => s.id == state.savedQuiz.section);
                    sectionName = section ? section.name : 'Section ' + state.savedQuiz.section;
                }
                document.getElementById('resumeInfo').textContent =
                    `${sectionName} • Question ${state.savedQuiz.questionIndex + 1} • Score: ${state.savedQuiz.score}`;
            } else {
                resumeBanner.classList.add('hide');
            }
        }

        // ==================== QUIZ LOGIC ====================
        async function startQuiz(sectionId) {
            if (state.savedQuiz && state.savedQuiz.section == sectionId) {
                if (confirm('You have a saved quiz. Resume it?\n\nOK = Resume, Cancel = Start New')) {
                    resumeQuiz();
                    return;
                } else {
                    await clearSavedQuiz();
                }
            }

            state.currentSection = sectionId;
            state.currentQuestionIndex = 0;
            state.score = 0;
            state.selectedAnswers = [];
            state.hasAnswered = false;
            state.isStudyMode = false;
            state.answeredQuestions = [];

            if (sectionId === 'final') {
                const shuffled = [...state.questions].sort(() => Math.random() - 0.5);
                state.currentQuizQuestions = shuffled.slice(0, CONFIG.finalExamQuestions);
                document.getElementById('quizTitle').textContent = 'Final Exam';
            } else {
                const section = CONFIG.sectionsConfig.find(s => s.id === sectionId);
                const sectionQuestions = state.questions.filter(q => q.id >= section.start && q.id <= section.end);
                state.currentQuizQuestions = sectionQuestions.sort(() => Math.random() - 0.5);
                document.getElementById('quizTitle').textContent = section.name;
            }

            hideAllScreens();
            document.getElementById('quizScreen').classList.remove('hide');
            document.getElementById('logoutBtn').classList.add('hide');

            syncQuizSession();
            loadQuestion();
        }

        async function resumeQuiz() {
            if (!state.savedQuiz) {
                showToast('No saved quiz found', 'error');
                return;
            }

            const saved = state.savedQuiz;

            state.currentSection = saved.section;
            state.currentQuestionIndex = saved.questionIndex;
            state.score = saved.score;
            state.isStudyMode = false;
            state.answeredQuestions = saved.answeredQuestions || [];
            state.hasAnswered = false;
            state.selectedAnswers = [];

            state.currentQuizQuestions = saved.questionsIds.map(id =>
                state.questions.find(q => q.id === id)
            ).filter(q => q !== undefined);

            if (saved.section === 'final') {
                document.getElementById('quizTitle').textContent = 'Final Exam';
            } else {
                const section = CONFIG.sectionsConfig.find(s => s.id == saved.section);
                document.getElementById('quizTitle').textContent = section ? section.name : 'Quiz';
            }

            hideAllScreens();
            document.getElementById('quizScreen').classList.remove('hide');
            document.getElementById('logoutBtn').classList.add('hide');

            showToast('Quiz resumed!', 'success');
            loadQuestion();
        }

        async function clearSavedQuiz() {
            if (state.savedQuiz) {
                await clearCloudSession(state.savedQuiz.section);
            }
            localStorage.removeItem('snquiz_saved_quiz');
            state.savedQuiz = null;
            document.getElementById('resumeBanner').classList.add('hide');
        }

        function loadQuestion() {
            const question = state.currentQuizQuestions[state.currentQuestionIndex];
            const total = state.currentQuizQuestions.length;
            const isMulti = question.type === 'multi';

            document.getElementById('quizSubtitle').textContent = `Question ${state.currentQuestionIndex + 1} of ${total}`;
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('currentScore').textContent = state.score;
            document.getElementById('quizProgressBar').style.width = ((state.currentQuestionIndex / total) * 100) + '%';

            const questionTypeBadge = document.getElementById('questionType');
            if (isMulti) {
                questionTypeBadge.textContent = `Multiple Choice (Select ${question.correct.length})`;
                questionTypeBadge.className = 'px-3 py-1 bg-orange-500/30 text-orange-300 rounded-full text-sm';
            } else {
                questionTypeBadge.textContent = 'Single Choice';
                questionTypeBadge.className = 'px-3 py-1 bg-purple-500/30 text-purple-300 rounded-full text-sm';
            }

            const isBookmarked = state.bookmarks.includes(question.id);
            document.getElementById('bookmarkIcon').className = isBookmarked ? 'fas fa-bookmark text-yellow-400' : 'far fa-bookmark';

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = Object.entries(question.options).map(([key, value]) => `
                <button onclick="selectOption('${key}')" id="option-${key}"
                    class="w-full text-left p-4 bg-white/5 border-2 border-white/10 rounded-xl hover:bg-white/15 hover:border-purple-400/50 transition-all duration-200 ease-out flex items-start gap-3 group">
                    <span class="w-8 h-8 ${isMulti ? 'rounded-md' : 'rounded-full'} border-2 border-purple-400/50 flex items-center justify-center shrink-0 transition-all duration-200 group-hover:border-purple-400" id="indicator-${key}">
                        ${isMulti
                    ? `<i class="fas fa-check text-sm text-transparent transition-all duration-200" id="check-${key}"></i>`
                    : `<span class="w-3 h-3 rounded-full bg-transparent scale-0 transition-all duration-200" id="radio-${key}"></span>`
                }
                    </span>
                    <span class="w-8 h-8 bg-purple-500/30 rounded-lg flex items-center justify-center font-bold text-sm shrink-0">${key}</span>
                    <span class="flex-1">${value}</span>
                </button>
            `).join('');

            if (isMulti) {
                optionsContainer.innerHTML = `
                    <div class="flex items-center gap-2 mb-3 p-3 bg-orange-500/10 border border-orange-500/30 rounded-xl">
                        <i class="fas fa-info-circle text-orange-400"></i>
                        <span class="text-sm text-orange-300">Select all correct answers (${question.correct.length} required)</span>
                    </div>
                ` + optionsContainer.innerHTML;
            }

            state.selectedAnswers = [];
            state.hasAnswered = false;
            document.getElementById('submitBtn').classList.remove('hide');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('nextBtn').classList.add('hide');
            document.getElementById('prevBtn').classList.add('hide');
            document.getElementById('feedbackContainer').classList.add('hide');

            startTimer();
        }

        function selectOption(option) {
            if (state.hasAnswered) return;

            const question = state.currentQuizQuestions[state.currentQuestionIndex];
            const optionBtn = document.getElementById(`option-${option}`);
            const isMulti = question.type === 'multi';

            if (isMulti) {
                const index = state.selectedAnswers.indexOf(option);
                const indicator = document.getElementById(`indicator-${option}`);
                const checkIcon = document.getElementById(`check-${option}`);

                if (index > -1) {
                    state.selectedAnswers.splice(index, 1);
                    optionBtn.classList.remove('option-selected-multi', 'scale-[1.02]');
                    optionBtn.classList.add('bg-white/5', 'border-white/10');
                    indicator.classList.remove('bg-orange-500', 'border-orange-400');
                    indicator.classList.add('border-purple-400/50');
                    checkIcon.classList.remove('text-white');
                    checkIcon.classList.add('text-transparent');
                } else {
                    state.selectedAnswers.push(option);
                    optionBtn.classList.add('option-selected-multi', 'scale-[1.02]');
                    optionBtn.classList.remove('bg-white/5', 'border-white/10');
                    indicator.classList.add('bg-orange-500', 'border-orange-400');
                    indicator.classList.remove('border-purple-400/50');
                    checkIcon.classList.add('text-white');
                    checkIcon.classList.remove('text-transparent');
                }

                updateSelectionCount(question);
            } else {
                Object.keys(question.options).forEach(key => {
                    const btn = document.getElementById(`option-${key}`);
                    const indicator = document.getElementById(`indicator-${key}`);
                    const radio = document.getElementById(`radio-${key}`);

                    btn.classList.remove('option-selected-single', 'scale-[1.02]');
                    btn.classList.add('bg-white/5', 'border-white/10');
                    indicator.classList.remove('border-violet-400', 'bg-violet-500');
                    indicator.classList.add('border-purple-400/50');
                    radio.classList.remove('bg-white', 'scale-100');
                    radio.classList.add('bg-transparent', 'scale-0');
                });

                state.selectedAnswers = [option];
                const indicator = document.getElementById(`indicator-${option}`);
                const radio = document.getElementById(`radio-${option}`);

                optionBtn.classList.add('option-selected-single', 'scale-[1.02]');
                optionBtn.classList.remove('bg-white/5', 'border-white/10');
                indicator.classList.add('border-violet-400', 'bg-violet-500');
                indicator.classList.remove('border-purple-400/50');
                radio.classList.add('bg-white', 'scale-100');
                radio.classList.remove('bg-transparent', 'scale-0');
            }
        }

        function updateSelectionCount(question) {
            const infoBox = document.querySelector('#optionsContainer > div:first-child');
            if (infoBox && question.type === 'multi') {
                const selected = state.selectedAnswers.length;
                const required = question.correct.length;
                const remaining = required - selected;

                let message = '';
                let colorClass = '';

                if (selected === 0) {
                    message = `Select all correct answers (${required} required)`;
                    colorClass = 'text-orange-300';
                } else if (remaining > 0) {
                    message = `${selected} selected, ${remaining} more needed`;
                    colorClass = 'text-orange-300';
                } else if (remaining === 0) {
                    message = `${selected} selected - Ready to submit!`;
                    colorClass = 'text-green-300';
                } else {
                    message = `${selected} selected (${required} expected)`;
                    colorClass = 'text-yellow-300';
                }

                infoBox.innerHTML = `
                    <i class="fas fa-info-circle ${remaining === 0 ? 'text-green-400' : 'text-orange-400'}"></i>
                    <span class="text-sm ${colorClass}">${message}</span>
                `;
            }
        }

        function submitAnswer() {
            if (state.selectedAnswers.length === 0) {
                showToast('Please select an answer', 'warning');
                return;
            }
            processAnswer();
        }

        async function processAnswer() {
            if (state.hasAnswered) return;

            state.hasAnswered = true;
            clearInterval(state.timer);

            const question = state.currentQuizQuestions[state.currentQuestionIndex];
            const isMulti = question.type === 'multi';
            const isCorrect = arraysEqual(state.selectedAnswers.sort(), question.correct.sort());

            if (isCorrect) {
                state.score++;
                document.getElementById('currentScore').textContent = state.score;
            } else {
                if (!state.wrongAnswers.includes(question.id)) {
                    state.wrongAnswers.push(question.id);
                }
            }

            showFeedback(isCorrect, question);

            Object.keys(question.options).forEach(key => {
                const optionBtn = document.getElementById(`option-${key}`);
                const indicator = document.getElementById(`indicator-${key}`);

                optionBtn.onclick = null;
                optionBtn.classList.remove('hover:bg-white/15', 'hover:border-purple-400/50', 'scale-[1.02]', 'option-selected-single', 'option-selected-multi');

                const isCorrectOption = question.correct.includes(key);
                const wasSelected = state.selectedAnswers.includes(key);

                if (isCorrectOption) {
                    optionBtn.classList.add('border-green-400', 'bg-green-500/30', 'correct-glow');
                    optionBtn.classList.remove('border-white/10', 'bg-white/5');
                    indicator.classList.remove('border-purple-400/50', 'border-violet-400', 'bg-violet-500', 'border-orange-400', 'bg-orange-500');
                    indicator.classList.add('border-green-400', 'bg-green-500');

                    if (isMulti) {
                        document.getElementById(`check-${key}`).classList.add('text-white');
                        document.getElementById(`check-${key}`).classList.remove('text-transparent');
                    } else {
                        const radio = document.getElementById(`radio-${key}`);
                        radio.classList.add('bg-white', 'scale-100');
                        radio.classList.remove('bg-transparent', 'scale-0');
                    }
                } else if (wasSelected) {
                    optionBtn.classList.add('border-red-400', 'bg-red-500/30', 'incorrect-glow');
                    optionBtn.classList.remove('border-white/10', 'bg-white/5');
                    indicator.classList.remove('border-purple-400/50', 'border-violet-400', 'bg-violet-500', 'border-orange-400', 'bg-orange-500');
                    indicator.classList.add('border-red-400', 'bg-red-500');

                    if (isMulti) {
                        document.getElementById(`check-${key}`).className = 'fas fa-times text-sm text-white';
                    } else {
                        const radio = document.getElementById(`radio-${key}`);
                        radio.classList.add('bg-white', 'scale-100');
                        radio.classList.remove('bg-transparent', 'scale-0');
                    }
                }
            });

            if (isMulti) {
                const infoBox = document.querySelector('#optionsContainer > div:first-child');
                if (infoBox) {
                    if (isCorrect) {
                        infoBox.innerHTML = `<i class="fas fa-check-circle text-green-400"></i><span class="text-sm text-green-300">All correct answers selected!</span>`;
                        infoBox.className = 'flex items-center gap-2 mb-3 p-3 bg-green-500/10 border border-green-500/30 rounded-xl';
                    } else {
                        const correctCount = state.selectedAnswers.filter(a => question.correct.includes(a)).length;
                        infoBox.innerHTML = `<i class="fas fa-times-circle text-red-400"></i><span class="text-sm text-red-300">You got ${correctCount} of ${question.correct.length} correct</span>`;
                        infoBox.className = 'flex items-center gap-2 mb-3 p-3 bg-red-500/10 border border-red-500/30 rounded-xl';
                    }
                }
            }

            document.getElementById('submitBtn').classList.add('hide');
            document.getElementById('nextBtn').classList.remove('hide');

            if (state.isStudyMode && state.currentQuestionIndex > 0) {
                document.getElementById('prevBtn').classList.remove('hide');
            }

            // Sync to cloud
            syncQuizSession();
            syncToCloud();
        }

        function showFeedback(isCorrect, question) {
            const container = document.getElementById('feedbackContainer');
            const content = document.getElementById('feedbackContent');
            const isMulti = question.type === 'multi';

            let partialInfo = '';
            if (isMulti && !isCorrect) {
                const correctSelected = state.selectedAnswers.filter(a => question.correct.includes(a)).length;
                const wrongSelected = state.selectedAnswers.filter(a => !question.correct.includes(a)).length;
                const missed = question.correct.filter(a => !state.selectedAnswers.includes(a)).length;

                partialInfo = `
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <div class="bg-green-500/10 rounded-lg p-3 text-center">
                            <p class="text-xl font-bold text-green-400">${correctSelected}</p>
                            <p class="text-xs text-green-300">Correct</p>
                        </div>
                        <div class="bg-red-500/10 rounded-lg p-3 text-center">
                            <p class="text-xl font-bold text-red-400">${wrongSelected}</p>
                            <p class="text-xs text-red-300">Wrong</p>
                        </div>
                        <div class="bg-yellow-500/10 rounded-lg p-3 text-center">
                            <p class="text-xl font-bold text-yellow-400">${missed}</p>
                            <p class="text-xs text-yellow-300">Missed</p>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 ${isCorrect ? 'bg-green-500' : 'bg-red-500'} rounded-full flex items-center justify-center">
                        <i class="fas ${isCorrect ? 'fa-check' : 'fa-times'} text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg">${isCorrect ? 'Correct!' : 'Incorrect'}</h3>
                        <p class="text-sm text-gray-400">${isCorrect ?
                    (isMulti ? `Great job! You selected all ${question.correct.length} correct answers.` : 'Great job!') :
                    (isMulti ? `The correct answers are: ${question.correct.join(', ')}` : `The correct answer is: ${question.correct[0]}`)
                }</p>
                    </div>
                </div>
                ${partialInfo}
                ${!isCorrect ? `
                    <div class="bg-white/5 rounded-xl p-4">
                        <p class="text-sm text-gray-300 mb-2"><strong class="flex items-center gap-2 mb-2"><i class="fas ${isMulti ? 'fa-check-square' : 'fa-check-circle'} text-green-400"></i>Correct Answer${question.correct.length > 1 ? 's' : ''}:</strong></p>
                        <div class="space-y-2">
                            ${question.correct.map(c => `
                                <div class="flex items-start gap-2 p-2 bg-green-500/10 rounded-lg">
                                    <span class="w-6 h-6 bg-green-500 rounded flex items-center justify-center text-sm font-bold shrink-0">${c}</span>
                                    <span class="text-green-300">${question.options[c]}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            `;

            container.classList.remove('hide');
        }

        async function nextQuestion() {
            const currentQuestion = state.currentQuizQuestions[state.currentQuestionIndex];
            if (!state.answeredQuestions.includes(currentQuestion.id)) {
                state.answeredQuestions.push(currentQuestion.id);
            }

            state.currentQuestionIndex++;

            if (state.currentQuestionIndex >= state.currentQuizQuestions.length) {
                await clearSavedQuiz();
                endQuiz();
            } else {
                syncQuizSession();
                loadQuestion();
            }
        }

        function previousQuestion() {
            if (state.currentQuestionIndex > 0) {
                state.currentQuestionIndex--;
                loadQuestion();
            }
        }

        async function endQuiz() {
            clearInterval(state.timer);

            const sectionKey = state.currentSection;
            const totalQuestions = state.currentQuizQuestions.length;
            const percentage = Math.round((state.score / totalQuestions) * 100);

            const existing = state.sectionProgress[sectionKey];
            if (!existing || existing.percentage < percentage) {
                state.sectionProgress[sectionKey] = {
                    correct: state.score,
                    total: totalQuestions,
                    percentage: percentage,
                    lastAttempt: new Date().toISOString()
                };
            }

            // Sync progress to cloud
            await syncToCloud();
            saveToLocalStorage();

            showResults();
        }

        function showResults() {
            hideAllScreens();
            document.getElementById('resultsScreen').classList.remove('hide');
            document.getElementById('logoutBtn').classList.remove('hide');

            const totalQuestions = state.currentQuizQuestions.length;
            const correct = state.score;
            const incorrect = totalQuestions - correct;
            const percentage = Math.round((correct / totalQuestions) * 100);

            document.getElementById('resultsCorrect').textContent = correct;
            document.getElementById('resultsIncorrect').textContent = incorrect;
            document.getElementById('resultsPercentage').textContent = percentage + '%';

            setTimeout(() => {
                document.getElementById('resultsProgressBar').style.width = percentage + '%';
            }, 100);

            const icon = document.getElementById('resultsIcon');
            const message = document.getElementById('resultsMessage');

            if (percentage >= 80) {
                icon.className = 'w-32 h-32 mx-auto mb-6 rounded-full flex items-center justify-center bg-gradient-to-br from-yellow-400 to-orange-500';
                message.textContent = 'Excellent! You\'re a master! 🎉';
            } else if (percentage >= 60) {
                icon.className = 'w-32 h-32 mx-auto mb-6 rounded-full flex items-center justify-center bg-gradient-to-br from-green-400 to-emerald-500';
                message.textContent = 'Good job! Keep practicing! 👍';
            } else {
                icon.className = 'w-32 h-32 mx-auto mb-6 rounded-full flex items-center justify-center bg-gradient-to-br from-purple-400 to-pink-500';
                message.textContent = 'Keep learning! You\'ll get better! 💪';
            }

            if (state.currentSection === 'final') {
                document.getElementById('resultsTitle').textContent = 'Final Exam Complete!';
            } else {
                const section = CONFIG.sectionsConfig.find(s => s.id === state.currentSection);
                document.getElementById('resultsTitle').textContent = section.name + ' Complete!';
            }
        }

        function retryQuiz() {
            startQuiz(state.currentSection);
        }

        function reviewAnswers() {
            state.isStudyMode = true;
            state.currentQuestionIndex = 0;

            hideAllScreens();
            document.getElementById('quizScreen').classList.remove('hide');
            document.getElementById('quizTitle').textContent = 'Review Answers';
            document.getElementById('logoutBtn').classList.add('hide');

            showToast('Review mode - see all correct answers', 'info');
            loadQuestion();
        }

        function showResetModal() {
            document.getElementById('resetModal').classList.remove('hide');
        }

        function closeResetModal() {
            document.getElementById('resetModal').classList.add('hide');
        }

        async function resetAllProgress() {
            state.sectionProgress = {};
            state.bookmarks = [];
            state.wrongAnswers = [];
            state.savedQuiz = null;

            // Clear from cloud
            if (supabase && state.currentUser) {
                try {
                    await supabase.from('user_progress').delete().eq('license_key', state.currentUser);
                    await supabase.from('bookmarks').delete().eq('license_key', state.currentUser);
                    await supabase.from('wrong_answers').delete().eq('license_key', state.currentUser);
                    await supabase.from('quiz_sessions').delete().eq('license_key', state.currentUser);
                } catch (e) {
                    console.error('Failed to clear cloud data:', e);
                }
            }

            // Clear local
            localStorage.removeItem('snquiz_progress');
            localStorage.removeItem('snquiz_bookmarks');
            localStorage.removeItem('snquiz_wrong_answers');
            localStorage.removeItem('snquiz_saved_quiz');

            closeResetModal();
            updateDashboard();
            showToast('All progress has been reset', 'success');
        }

        function exitQuiz() {
            if (confirm('Exit quiz? Your progress will be saved.')) {
                clearInterval(state.timer);
                syncQuizSession();
                showDashboard();
            }
        }

        // ==================== TIMER ====================
        function startTimer() {
            clearInterval(state.timer);

            if (state.isStudyMode) {
                document.getElementById('timerContainer').classList.add('hide');
                return;
            }

            document.getElementById('timerContainer').classList.remove('hide');

            const timeLimit = state.currentSection === 'final' ? CONFIG.finalExamTimeLimit : CONFIG.questionTimeLimit;
            state.timeRemaining = timeLimit;
            updateTimerDisplay();

            state.timer = setInterval(() => {
                state.timeRemaining--;
                updateTimerDisplay();

                if (state.timeRemaining <= 0) {
                    clearInterval(state.timer);
                    if (!state.hasAnswered) {
                        showToast('Time\'s up!', 'warning');
                        processAnswer();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timerDisplay');
            const circle = document.getElementById('timerCircle');

            const timeLimit = state.currentSection === 'final' ? CONFIG.finalExamTimeLimit : CONFIG.questionTimeLimit;

            if (state.currentSection === 'final') {
                const minutes = Math.floor(state.timeRemaining / 60);
                const seconds = state.timeRemaining % 60;
                display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                display.textContent = state.timeRemaining;
            }

            const circumference = 2 * Math.PI * 16;
            const progress = state.timeRemaining / timeLimit;
            circle.style.strokeDashoffset = circumference * (1 - progress);

            if (state.timeRemaining <= 10) {
                circle.style.stroke = '#ef4444';
                display.classList.add('text-red-400');
            } else if (state.timeRemaining <= 30) {
                circle.style.stroke = '#f59e0b';
                display.classList.remove('text-red-400');
            } else {
                circle.style.stroke = '#a855f7';
                display.classList.remove('text-red-400');
            }
        }

        // ==================== BOOKMARKS ====================
        async function toggleBookmark() {
            const question = state.currentQuizQuestions[state.currentQuestionIndex];
            const index = state.bookmarks.indexOf(question.id);

            if (index > -1) {
                state.bookmarks.splice(index, 1);
                document.getElementById('bookmarkIcon').className = 'far fa-bookmark';
                showToast('Bookmark removed', 'info');
            } else {
                state.bookmarks.push(question.id);
                document.getElementById('bookmarkIcon').className = 'fas fa-bookmark text-yellow-400';
                showToast('Question bookmarked!', 'success');
            }

            saveToLocalStorage();
            syncToCloud();
        }

        function viewBookmarks() {
            if (state.bookmarks.length === 0) {
                showToast('No bookmarked questions', 'info');
                return;
            }

            state.isStudyMode = true;
            state.currentSection = 'bookmarks';
            state.currentQuestionIndex = 0;
            state.score = 0;
            state.currentQuizQuestions = state.questions.filter(q => state.bookmarks.includes(q.id));

            hideAllScreens();
            document.getElementById('quizScreen').classList.remove('hide');
            document.getElementById('quizTitle').textContent = 'Bookmarked Questions';
            document.getElementById('logoutBtn').classList.add('hide');

            loadQuestion();
        }

        function viewWrongAnswers() {
            if (state.wrongAnswers.length === 0) {
                showToast('No wrong answers to review', 'info');
                return;
            }

            state.isStudyMode = true;
            state.currentSection = 'wrong';
            state.currentQuestionIndex = 0;
            state.score = 0;
            state.currentQuizQuestions = state.questions.filter(q => state.wrongAnswers.includes(q.id));

            hideAllScreens();
            document.getElementById('quizScreen').classList.remove('hide');
            document.getElementById('quizTitle').textContent = 'Review Wrong Answers';
            document.getElementById('logoutBtn').classList.add('hide');

            loadQuestion();
        }

        // ==================== STUDY MODE ====================
        function startStudyMode() {
            document.getElementById('studyModeModal').classList.remove('hide');

            const container = document.getElementById('studyModeSections');
            container.innerHTML = CONFIG.sectionsConfig.map(section => `
                <button onclick="startStudySection(${section.id})" 
                    class="w-full p-3 bg-white/5 rounded-xl hover:bg-white/10 transition flex items-center gap-3">
                    <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center">
                        <i class="fas ${section.icon}"></i>
                    </div>
                    <span>${section.name} (Q${section.start}-${section.end})</span>
                </button>
            `).join('');

            container.innerHTML += `
                <button onclick="startStudySection('all')" 
                    class="w-full p-3 bg-purple-500/20 rounded-xl hover:bg-purple-500/30 transition flex items-center gap-3 mt-4">
                    <div class="w-10 h-10 gradient-bg-alt rounded-lg flex items-center justify-center">
                        <i class="fas fa-globe"></i>
                    </div>
                    <span>All Questions (Random)</span>
                </button>
            `;
        }

        function closeStudyMode() {
            document.getElementById('studyModeModal').classList.add('hide');
        }

        function startStudySection(sectionId) {
            closeStudyMode();

            state.isStudyMode = true;
            state.currentSection = sectionId;
            state.currentQuestionIndex = 0;
            state.score = 0;

            if (sectionId === 'all') {
                state.currentQuizQuestions = [...state.questions].sort(() => Math.random() - 0.5);
                document.getElementById('quizTitle').textContent = 'Study Mode - All Questions';
            } else {
                const section = CONFIG.sectionsConfig.find(s => s.id === sectionId);
                state.currentQuizQuestions = state.questions
                    .filter(q => q.id >= section.start && q.id <= section.end)
                    .sort(() => Math.random() - 0.5);
                document.getElementById('quizTitle').textContent = 'Study Mode - ' + section.name;
            }

            hideAllScreens();
            document.getElementById('quizScreen').classList.remove('hide');
            document.getElementById('logoutBtn').classList.add('hide');

            loadQuestion();
        }

        // ==================== UTILITIES ====================
        function togglePasswordVisibility() {
            const input = document.getElementById('licenseKeyInput');
            const icon = document.getElementById('passwordToggleIcon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hide');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const text = document.getElementById('toastMessage');

            text.textContent = message;

            switch (type) {
                case 'success':
                    icon.className = 'fas fa-check-circle text-green-400';
                    break;
                case 'error':
                    icon.className = 'fas fa-exclamation-circle text-red-400';
                    break;
                case 'warning':
                    icon.className = 'fas fa-exclamation-triangle text-yellow-400';
                    break;
                case 'info':
                    icon.className = 'fas fa-info-circle text-blue-400';
                    break;
            }

            toast.style.transform = 'translateX(0)';

            setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
            }, 3000);
        }

        function maskLicense(license) {
            if (!license) return '';
            return license.substring(0, 8) + '****';
        }

        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('quizScreen').classList.contains('hide')) return;

            if (!state.hasAnswered) {
                if (e.key >= '1' && e.key <= '4') {
                    const options = ['A', 'B', 'C', 'D'];
                    selectOption(options[parseInt(e.key) - 1]);
                }
                if (e.key === 'Enter') {
                    submitAnswer();
                }
            } else {
                if (e.key === 'Enter' || e.key === 'ArrowRight') {
                    nextQuestion();
                }
            }
        });

        // Initialize app
        init();
    </script>
</body>

</html>